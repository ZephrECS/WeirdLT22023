<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <title>Dig Out Of Prison</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }
        
        canvas:focus {
            outline: none;
        }
        
        #unity-container {
            width: 100%;
            height: 100vh;
        }
        
        #unity-canvas {
            width: 100%;
            height: 100%;
            background: #231f20;
        }
        
        #loading-cover {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #231f20;
        }
        
        #unity-loading-bar {
            text-align: center;
        }
        
        #unity-logo img {
            max-width: 200px;
            margin-bottom: 20px;
        }
        
        #unity-progress-bar-empty {
            width: 300px;
            height: 18px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 9px;
        }
        
        #unity-progress-bar-full {
            width: 0%;
            height: 100%;
            background: #4CAF50;
            border-radius: 9px;
            transition: width 0.3s;
        }
        
        .spinner {
            height: 50px;
            width: 50px;
            margin: 20px auto;
            animation: rotation .6s infinite linear;
            border-left: 6px solid rgba(255, 255, 255, .15);
            border-right: 6px solid rgba(255, 255, 255, .15);
            border-bottom: 6px solid rgba(255, 255, 255, .15);
            border-top: 6px solid rgba(255, 255, 255, .8);
            border-radius: 100%;
        }
        
        @keyframes rotation {
            from {transform: rotate(0deg);}
            to {transform: rotate(359deg);}
        }
    </style>
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
    </div>
    <div id="loading-cover">
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
            <div class="spinner"></div>
        </div>
    </div>
    
    <script>
        const RAW_GITHUB_BASE = "https://raw.githubusercontent.com/ZephrECS/WeirdLT22023/main/DigOutOfPrison/";
        const JSDELIVR_BASE = "https://cdn.jsdelivr.net/gh/ZephrECS/WeirdLT22023@main/DigOutOfPrison/";
        
        // Files that are split into .part1 and .part2
        const SPLIT_FILES = [
            'a4e4e4588738c16ec10d71d22926ae68.data.br',
            '7596a49439dcfec08e5215bed2a9eec3.wasm.br'
        ];
        
        // Custom fetch that merges split files
        const originalFetch = window.fetch;
        window.fetch = async function(url, options) {
            const urlStr = url.toString();
            
            // Check if this URL is requesting one of the split files
            const splitFile = SPLIT_FILES.find(filename => urlStr.endsWith(filename));
            
            if (splitFile) {
                console.log('Intercepting request for split file:', splitFile);
                
                try {
                    // Construct URLs for both parts
                    const part1Url = urlStr + '.part1';
                    const part2Url = urlStr + '.part2';
                    
                    console.log('Fetching:', part1Url);
                    console.log('Fetching:', part2Url);
                    
                    // Fetch both parts in parallel
                    const [response1, response2] = await Promise.all([
                        originalFetch(part1Url),
                        originalFetch(part2Url)
                    ]);
                    
                    if (!response1.ok || !response2.ok) {
                        throw new Error(`Failed to fetch parts: ${response1.status}, ${response2.status}`);
                    }
                    
                    // Get the array buffers
                    const [buffer1, buffer2] = await Promise.all([
                        response1.arrayBuffer(),
                        response2.arrayBuffer()
                    ]);
                    
                    // Merge the buffers
                    const mergedBuffer = new Uint8Array(buffer1.byteLength + buffer2.byteLength);
                    mergedBuffer.set(new Uint8Array(buffer1), 0);
                    mergedBuffer.set(new Uint8Array(buffer2), buffer1.byteLength);
                    
                    console.log(`Merged ${splitFile}: ${mergedBuffer.byteLength} bytes (${buffer1.byteLength} + ${buffer2.byteLength})`);
                    
                    // Create a new response with the merged data
                    return new Response(mergedBuffer, {
                        status: 200,
                        statusText: 'OK',
                        headers: response1.headers
                    });
                } catch (error) {
                    console.error('Error merging files:', error);
                    throw error;
                }
            }
            
            // For all other requests, use original fetch
            return originalFetch(url, options);
        };
        
        // Auto-load game when page loads
        window.addEventListener('load', function() {
            loadGame();
        });
        
        function loadGame() {
            // Use jsdelivr for the loader (JavaScript file, works fine)
            const loaderUrl = JSDELIVR_BASE + "Build/ca98492c4e603014560541ecf62d8174.loader.js";
            
            // Use raw GitHub for all .br files (they need to be served with correct headers)
            const buildUrl = RAW_GITHUB_BASE + "Build";
            
            const config = {
                dataUrl: buildUrl + "/a4e4e4588738c16ec10d71d22926ae68.data.br",
                frameworkUrl: RAW_GITHUB_BASE + "a25d3e539f772ceb6e8712015eceb9e4.framework.js.br",
                codeUrl: buildUrl + "/7596a49439dcfec08e5215bed2a9eec3.wasm.br",
                streamingAssetsUrl: RAW_GITHUB_BASE + "StreamingAssets",
                companyName: "polar men",
                productName: "Dig out of Prison",
                productVersion: "0.1"
            };

            const container = document.querySelector("#unity-container");
            const canvas = document.querySelector("#unity-canvas");
            const loadingCover = document.querySelector("#loading-cover");
            const progressBarEmpty = document.querySelector("#unity-progress-bar-empty");
            const progressBarFull = document.querySelector("#unity-progress-bar-full");
            const spinner = document.querySelector('.spinner');

            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                container.className = "unity-mobile";
            }

            document.addEventListener('contextmenu', event => event.preventDefault());

            const script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    spinner.style.display = "none";
                    progressBarEmpty.style.display = "";
                    const adjustedProgress = Math.max(progress, 0.05);
                    progressBarFull.style.width = `${100 * adjustedProgress}%`;
                }).then((unityInstance) => {
                    loadingCover.style.display = "none";
                }).catch((message) => {
                    console.error(message);
                    alert('Error loading game: ' + message);
                });
            };
            script.onerror = () => {
                alert('Failed to load Unity loader. Check console for details.');
            };
            document.body.appendChild(script);
        }
    </script>
</body>
</html>
